plot.scores <-
function (data.i,data.list,pdf.name = "qc.control", open.doc = T,pdfOut = F,BSACheck = F,colType = c("greenblue"))
{
cat("\rplotting scores",rep(" ",100))
#initiation of important vectors 
if(colType == "greenblue"){
grad.cols.vec <- c("black","blue","lightblue",colors()[50])}else{
grad.cols.vec <- c("black","indianred1","yellow2",colors()[50])}

MaxCol <- "blue"
colnames(data.i) <- tolower(colnames(data.i))
summary.data 	<- data.list$sd
thresholds 		<- data.list$th
score		 	<- data.list$sc
data.i.quant 	<- data.list$diq

na.inf.fun <- function(x){
	x[is.na(x)] 		<- 0
	x[is.infinite(unlist(x))] 	<- 0
	return(x)
}


score     <- na.inf.fun(score)

color.blind <- list(	

		yellow = rgb(240,228,66,max = 255),
		orange = rgb(230,159,0,max = 255),
		vermillion = rgb(213,94,0,max = 255),
		bluishgreen = rgb(0,158,115,max = 255),
		reddishpurple = rgb(204,121,167,max = 255), 		skyblue = rgb(86,180,233,max = 255),
		blue = rgb(0,133,178,max = 255)

)

  if(pdfOut){
pdf(.pdf<- paste(pdf.name,".pdf",sep = ""),width = 16.5,height = 7.7,pointsize = 20)
# plot scores
}
library(gplots)
real.data 		<- summary.data
ref.data 		<- thresholds
score.data 	<<- score
ms.col <- unlist(color.blind[c(5,6,1)])
nc.col <- unlist(color.blind[c(3,4,2)])
sum.scores <- c(sum(unlist(score.data[1:3])),sum(unlist(score.data)[4:6]))

TotalScore <<- unlist(score.data) 
TotalScore[TotalScore > 1] <- 1
#TotalScore <- as.data.frame(t(as.data.frame(TotalScore)))

matchPa <- c("msms","msmsCount.50%","msmsQuantile.50%","mass.error","score.50%","peak.shape")
Temp <- merge.control(names(TotalScore),matchPa)

finalAna <- TotalScore[Temp]
finalAna[is.na(finalAna)] <- 0		
TotalScore <- as.data.frame(t(as.data.frame(TotalScore)))
if(BSACheck){
	finalAna[1] <- TotalScore$ProteinCoverage
}

TotalScore <- sum(as.numeric(as.character(finalAna)))/(length(finalAna))
if(TotalScore > finalAna[1]){TotalScore <- finalAna[1]}

if(any(sum.scores > 3)){
	
	temp.xlim <- c(0,max(sum.scores))
	
	}else{temp.xlim <- c(0,3)
		
}
nrowVal <- 6
ncolVal <- 8
extra <- 0
totalFill 	<- nrowVal* ncolVal

profileSpace <- matrix(c(rep(1,(nrowVal-1)),2,rep(3,(nrowVal-1)),4),ncol = 2,nrow = nrowVal)
#any(summary.data$msmsQuantile != 0)& 
if(  1==0){
	scoreSpace 	 <- matrix(c(6,6,rep(5,(2*(ncolVal-3)-2)),7,7),ncol =(ncolVal-2),nrow = 2 )	
	addNum <- 1
}else{
	scoreSpace 	 <- matrix(c(rep(5,(ncolVal-2)),6,6,20,20,19,19),ncol =(ncolVal-2),nrow = 2 )	
	addNum <- 0
	
}
byRow <- F
if(byRow){
leftSpace	 	<- (nrowVal-2)*(ncolVal-2)/2
leftSpace 		<- seq(from = 7,to = (leftSpace+6))
topLeftSpace 	<- min(leftSpace):leftSpace[length(leftSpace)/2]
downLeftSpace 	<- (leftSpace[length(leftSpace)/2]+1):max(leftSpace)
leftSpace 		<- rbind(topLeftSpace, topLeftSpace, downLeftSpace, downLeftSpace)
leftSpace <- leftSpace + addNum
}else{
leftSpace	 	<- (nrowVal-2)*(ncolVal-2)/2
leftSpace 		<- seq(from = 7,to = (leftSpace+6))
n <- length(leftSpace) / (ncolVal-2)
to <- (ncolVal-2)
leftSpaceM <- c()
init <- 1
for(b in 1:n){
	tempB <- rbind(leftSpace[init:(to*b)], leftSpace[init:(to*b)])
	leftSpaceM <- rbind(leftSpaceM, tempB)
	init <- init + to
}
leftSpace <- leftSpaceM
#leftSpace 		<- as.vector(sapply(leftSpace,function(x){x <- c(x,x)}))
#leftSpaceM <- matrix(leftSpace[1:],nrow = (nrowVal-2-2),ncol = (ncolVal-2))
	
}



totalSpace 		<- cbind(profileSpace,rbind(scoreSpace,leftSpace))


layout(totalSpace,width = c(2.3,0.3,0.5,0.5,0.5,0.5,0.5,0.5))
par(mai = c(0,1,0.1,0))

if(any(grep.col("calibrated.retention.time.start",data.i) == 0|grep.col("calibrated.retention.time.finish",data.i) == 0)){
	dots <- F
}else{dots <- T}

try(plotData<- plot.profile(data.i,F,dots,BSACheck= BSACheck))
xVal <- 1.6
yVal <- 4.2
abline(v=c(xVal, xVal*4.05),xpd = NA,lwd = 3,col = "grey")
lines(x = c(xVal,1000),y = rep(yVal,2),xpd = NA,lwd = 3,col = "grey")
lines(x = c(xVal,100),y = rep(yVal*0.56,2),xpd = NA,lwd = 3,col = "grey")
#lines(x = rep(8.5,2),y = c(-5000,1000),xpd = NA,lwd = 3,col = "grey")


par(mai = c(0.4,2,0.2,0.1))
#assc#ign("score.data",score.data,envir = .GlobalEnv)
#barplot2(cbind(score.data[1:3],rep(0,3)),names.arg = c("MS-score","nLC"),ylim = temp.xlim,col = ms.col,las = 2,ylab = "score")
#temp.pos <- barplot2(cbind(rep(0,3),score.data[4:6]),ylim = temp.xlim,col = nc.col,las = 2,axes = F,add = T)

round.spec <- function(x){ 
		x<- round(x*100)
		x[x > 100] <- 100
		x[is.na(x)] <- 100
		x[x == 0] <- 1
		return(x)
		}
col.temp <- (colorRampPalette(grad.cols.vec)(100))
score.data <- score.data[names(score.data)!=""]
orderScores <- c("msms","mass.error","score","msmsQuantile","quan.duplicates.msms","msmsCount","msmsEff","ret.width","peak.shape","quanRetRSD","quanRetSlope","quanRet50ratio")
if(BSACheck){
	
	orderScores[1] <- "ProteinCoverage"
}



score.order <- merge.control(names(score.data),orderScores)
diff 		<- setdiff(1:length(names(score.data)),score.order[!is.na(score.order)])
if(length(diff) > 0){
	score.order[is.na(score.order)] <- diff
}

score.data <- score.data[rev(score.order)]



namesData <- names(score.data)

namesData[namesData=="quanRetRSD"] <- "ETime rSD"
namesData[namesData=="quanRetSlope"] <- "ETime slope"
namesData[namesData=="quanRet50ratio"] <- "ETime balance"
namesData[namesData=="quan.duplicates.msms"] <- "Duplicates/Peptide IDs"
namesData[namesData=="msms"] <- "Peptide ID/min"
namesData[namesData=="ProteinCoverage"] <- "BSA Protein Coverage in %"

namesData[namesData=="mass.error"]  <- "Mass error in ppm"
namesData[namesData=="score"] <- "Andromeda Score"
namesData[namesData=="peak.shape"]   <- "Peak Shape"
namesData[namesData=="ret.width"]     <- "Peak Width"
  namesData[namesData=="msmsQuantile"] <- "MSMS Intensities"
namesData[namesData=="msmsEff"]   <- "Efficiency MSMS"
namesData[namesData=="msmsCount"] <- "Fragments Counts / MSMS"



par(mai = c(0.5,1,0.3,0.5))

CombiScores <- score[grep("combi",names(score))]
if(length(CombiScores) > 0){
CombiScores <- CombiScores[grep("nLC",names(CombiScores),invert = T)]
CombiScores <- unlist(CombiScores)
CombiScores <- CombiScores[order(names(CombiScores))]


namesData <- c("MS","MSMS","LC","DS")
ColScore <- c(col.temp[round.spec(c(CombiScores, TotalScore))])
SCVecs <- c(CombiScores, TotalScore)
names(ColScore) <- namesData
names(SCVecs) <- namesData
temp.pos 	<- barplot2(SCVecs,beside = T,col = ColScore ,horiz = F,names.arg = namesData ,las = 1, plot.grid = T, grid.col = "grey",border = "transparent",xpd = F,ylim = c(0,1.2),ylab = "Score")
ColUse 		<<- cbind(c(col.temp[round.spec(unlist(CombiScores))]),names(score.data),namesData)

#text(temp.pos,0,c("peptide ID","mass error","score","peak shape","elution time","dupl. peptide IDs"),las = 2,srt = 90,adj = c(1.1,1),xpd =NA,srt = 45)
mtext("System Performance",3,line = 0,cex = 0.6)
#abline(h=1,col = "grey",lwd = 5)
abline(h=1,col = MaxCol,lwd = 2)
}else{
	empty.plot()

}
#par(mai = c(0.5,2,0.1,0.1))

# col.vec for plot.quans 


par(mai = c(0.17,1,0.5,0.2),bg = "lightblue")
init.i <- 500
""
#plot(1,frame = F,axes=F,xlab = "",ylab = "",type = "n",ylim = c(0,init.i))
col.temp.2 <- (colorRampPalette(grad.cols.vec)(init.i))

#par(mai = c(0.1,0.1,0.1,0.1),bg = "transparent")
#empty.plot()

par(mai = c(0.17,1,1,0.2),bg = "white")

 hu <-barplot2(0.8,las = 2,col ="grey",ylab = "Parameter",ylim = c(0,1.2),bg = "transparent",angle = 45,density = 35,xpd = F,names.arg = "")
abline(h=1,lwd = 3,col = MaxCol)
text(hu*1.4,1,"Best",xpd = NA,col = MaxCol,pos = 4)
mtext("LEGEND",3,col = "grey",line =  3)
box(lwd = 4,fg = "grey")

par(mai = c(0.17,1,0.5,0.2),bg = "lightblue")

# for(col.i in 1:init.i){
	# abline(h = col.i,col = col.temp.2[col.i],lwd = 0.5)
# }


# mtext("Good",2,adj = 1,cex = 0.8)
# mtext("Poor",2,adj = 0,cex = 0.8)
# if(BSACheck){
	# mtext("BSA",2,cex = 1.5,line = 4,las = 2,col = "darkgrey")
# }


#mtext("Color\nCode",3,cex = 0.8)
#legend(max(temp.pos)+ temp.pos[1],max(temp.xlim),legend = c("peptide ID","mass error","score","peak shape","elution time","duplicated peptide IDs"),,fill = c(ms.col,nc.col),xpd = NA,xjust = 0,bty = "n",title = "Legend")

par(mai = c(0,0,0,0))
#empty.plot <- function(ylimVec = c(0,1)){plot(1,type = "n",axes = F,xlab = "",ylab ="",ylim = ylimVec)}
#empty.col()
#empty.plot()

# plot real data
par(mai = c(0.17,1,0.5,0.2),bg = "lightblue")
plot.quans <- function(temp.plot,log2,xlab ="",ylab = "",ref.data,thresh.auto = T,bg ="lightblue",fg.col = 1 ,main = "",ylim = range(temp.plot)){
# if fg.vol is 0 
if(length(fg.col) == 0){fg.col <- 1}
	
if(log2){
	temp.plot <- log2(temp.plot)
}
temp.plot <- na.inf.fun(temp.plot)

#boxplot(temp.plot,type = "n",xlim = c(1:2),axes = F,frame = T,xlab = xlab,ylab = ylab,lwd = 5,las = 2,fg = fg.col,bty = "n",ylim = ylim, boxwex = 2)
boxplot(temp.plot,range = 0,col = "transparent",xlab = "",ylab = "",type = "n",axes = F,border = "transparent")

mtext(xlab,1,line = 1)
mtext(main,3,line = 0.3,cex = 0.7)

temp.lwd <- c(4,4,5,4,4)
temp.col <- c(4,2,1,2,4)
#for(i in 1:5){
#	lines(c(1.2, 1.8),rep(temp.plot[i],2),lwd = temp.lwd[i],col = temp.col[i])
#}

if(log2){
#abline(h=sort(c(-ref.data,ref.data,0)),col = "black", lty = "dashed",lwd = 1)	
abline(h=sort(c(-ref.data,ref.data,0)),col = temp.col,lwd = 2,lty = c(rep("11",2),rep("solid",3))	)
}
if(!log2){
abline(h=sort(c(ref.data)),col = temp.col,lwd = 2,lty = c(rep("11",2),rep("solid",3)))	
	
}
axis(2,las = 2,fg = 1,lwd = 2)
box(lwd = 4,fg = fg.col)
boxplot(temp.plot,range = 0,col = fg.col,xlab = xlab,ylab = ylab,type = "n",axes = F,add = T)


}

plot.stat <- function(x,thresh, name.val,rev = F,bg = "lightblue",main = "2",col.dir = NULL,xlimV = NULL){
	col.temp <- (colorRampPalette(c(MaxCol,"yellow","green"))(thresh*100))
	
		if(rev){
		col.temp <- (colorRampPalette(c(MaxCol,"yellow"))(thresh*100))
		col.temp <- rev(c(col.temp,rep("green",thresh*100)))	
		}

	x[is.na(x)] <- 0
	if(x > thresh){
		col.sel <- thresh
		x.range <- c(0,x+x*0.2)
	}else{
		col.sel <- x
		x.range <- c(0,thresh+thresh*0.2)

	}
	if(length(xlimV) == 2){
		x.range <- as.numeric(xlimV)
	}
	if(length(col.dir) == 0){col.dir <- col.temp[col.sel*100]}
	
	max(c(x,thresh))
	barplot2(x,las = 2,col =col.dir,ylab = name.val,ylim = x.range,bg = bg,angle = 45,density = 35,xpd = F,names.arg = "")
	#abline(h=thresh,lwd = 2,col = "grey")
	abline(h=thresh,lwd = 3,col = MaxCol)
		box(lwd = 4,fg = col.dir)

	mtext(main,3,cex =0.7,line = 0.3)

}

#plot.stat(summary.data$msms.count,thresholds$msms.count, name.val = "MSMS counts")
##
# Peptide ID/min
##
if(BSACheck){
trytest <- 	try(plot.stat(summary.data$Coverage,thresholds$ProteinCoverage, name.val = "BSA Protein Coverage in %",main = "MS", col.dir = col.temp[round.spec(score$ProteinCoverage)]))

}else{
trytest <- try(plot.stat(summary.data$quan.msms.min,thresholds$quan.msms.min, name.val = "Peptide ID/min",main = "MS", col.dir = col.temp[round.spec(score$msms)]))
}

if(class(trytest) == "try-error"){
	empty.plot()
}
####
# Intensity
####

logInt <- log10(thresholds$Intensities)
logInt <- c(min(logInt)- diff(logInt), logInt)
logInt <- c(logInt,min(logInt) * 0.5,max(logInt) * 1.5)

trytest <- try(plot.quans(log10(summary.data$Intensity),F,"","log10 Intensity",logInt,fg.col = col.temp[round.spec(score$Intensity)],main = "MS"))

if(class(trytest) == "try-error"){
	empty.plot()
}

###
# mass error
###
trytest <- try(plot.quans(summary.data$mass.error.cal,F,"","Mass error in ppm",c(thresholds$mass.error.cal,-thresholds$mass.error.cal,0),fg.col = col.temp[round.spec(score$mass.error)],main = "MS"))
if(class(trytest) == "try-error"){
	empty.plot()
}

#par(mai = c(0.2,1,0.5,0.2),bg = "lightblue")


##
# peak shape
##
trytest <- try(plot.quans(summary.data$ret.peak.shape,T,"","log2(Peak shape)",thresholds$ret.peak.shape,fg.col = col.temp[round.spec(score$peak.shape)],main = "nLC")
)
if(class(trytest) == "try-error"){
	empty.plot()
}
##
# peak width
## 

trytest <- try(plot.quans(summary.data$ret.width,F,"","Peak width in min",c(0,0.1,0.3,1,4),fg.col = col.temp[round.spec(score$ret.width)],main = "nLC",ylim = range(summary.data$ret.width[1:4]))
)

if(class(trytest) == "try-error"){
	empty.plot()
}

##
# ET time balance
## 

#try(plot.stat(log2(data.list$sd$quanRet50ratio),thresh = c(log2(data.list$th$quanRet50ratio),-1*log2(data.list$th$quanRet50ratio)),name.val = "log2 ETime balance",main = "nLC",col = ColUse[ColUse[,2] == "quanRet50ratio",1],xlimV = c(-1,1)))
trytest <- try(plot.stat(data.list$sc$nLCcombi, 1,name.val = "Elution Performance",main = "nLC",col = c(col.temp[round.spec(data.list$sc$nLCcombi)])))
if(class(trytest) == "try-error"){
	empty.plot()
}



##
# Iden efficiency
##
trytest <- try(plot.stat(summary.data$msmsEff,60,name.val = "Identification efficiency in %",main = "MSMS",col = col.temp[round.spec(score$msmsEff)]))
if(class(trytest) == "try-error"){
	empty.plot()
}
##
# msmsIntensities
##
#return(summary.data)

#if(any(summary.data$msmsQuantile != 0)){
threshDat <- as.numeric(unlist(strsplit(as.character(thresholds$msmsQuantile)," ")))

trytest <- try(plot.quans(as.numeric(log10(summary.data$msmsQuantile)),F,ref.data = c(threshDat[1]*0.7,threshDat[1]*0.9,threshDat, threshDat[2] * 1.2),main = "MSMS",xlab = "",ylab = "MSMS log10(Intensities)",fg.col = col.temp[round.spec(score$msmsQuantile)]))
#}
if(class(trytest) == "try-error"){
	empty.plot()
}

#if(any(summary.data$msmsMassCount != 0)){
threshDat <- as.numeric(unlist(strsplit(as.character(thresholds$msmsCount)," ")))

trytest <- try(plot.quans(as.numeric(summary.data$msmsMassCount),F,ref.data = c(0,threshDat[1]-diff(threshDat),threshDat[1], threshDat[2],threshDat[2]*2),main = "MSMS",xlab = "",ylab = "Fragment Counts / MSMS",fg.col = col.temp[round.spec(score$msmsCount)]))
#}
if(class(trytest) == "try-error"){
	empty.plot()
}



###
# score
###
trytest <- try(plot.quans(summary.data$score,F,"","Andromeda score",c(0,50,100,150,400),fg.col = col.temp[round.spec(score$score)],main = "Misc")
)
if(class(trytest) == "try-error"){
	empty.plot()
}
##
# Duplicates
##
trytest <- try(plot.stat(summary.data$quan.duplicates.msms, thresholds$quan.duplicates.msms, name.val = "Duplicates/Peptide IDs in %",rev = T,main = "Misc",col.dir = col.temp[round.spec(score$quan.duplicates.msms)]))


if(class(trytest) == "try-error"){
	empty.plot()
}



empty.plot()


par(mai = c(0.17,1,0.5,0.2),bg = "lightblue")
init.i <- 500
""
plot(1,frame = F,axes=F,xlab = "",ylab = "",type = "n",ylim = c(0,init.i))
col.temp.2 <- (colorRampPalette(grad.cols.vec)(init.i))
for(col.i in 1:init.i){
	abline(h = col.i,col = col.temp.2[col.i],lwd = 0.5)
}


mtext("Good",2,adj = 1,cex = 0.7,xpd = NA)
mtext("Poor",2,adj = 0,cex = 0.7,xpd = NA)
mtext("Score Color Code",2,cex = 0.7,xpd = NA,line = 1.3)



empty.plot(ylimVec = c(1,5))
abline(h = c(1,2,3,4,5),col = c(4,2,1,2,4),lwd = 3,lty = c(rep("11",2),rep("solid",3)))

text(rep(1,5),c(1,2,3,4,5),c("0%","25%","50%","75%","100%"),pos = 3,xpd = NA)##
mtext("Quantile Color Code",2,cex = 0.7,line = 0.5) 


# if(BSACheck){
	# mtext("MQQC\nBSA",2,cex = 1.5,line = 4,las = 2,col = "darkgrey")
# }else{
# mtext("MQQC",2,cex = 1.5,line = 4,las = 2,col = "darkgrey")

# }


# ET time slope
## 

#try(plot.stat((data.list$sd$quanRetSlope),thresh = c(data.list$th$quanRetSlope,-1*data.list$th$quanRetSlope),name.val = "ETime slope",main = "nLC",col = ColUse[ColUse[,2] == "quanRetSlope",1],xlimV = c(-0.05,0.05)))

##
# ET time slope
## 

#try(plot.stat((data.list$sd$quanRetRSD),thresh = data.list$th$quanRetRSD,name.val = "ETime rSD",main = "nLC",col = ColUse[ColUse[,2] == "quanRetRSD",1]))


##plot.quans(summary.data$mass.error.cal,F,"mass.error","mass.error in ppm",thresholds$mass.error.cal)




if(pdfOut){
	  
	graphics.off()
}
cat("\r",getwd())

if(open.doc){
	try(        try(system(paste("open ", .pdf), intern = TRUE, 				ignore.stderr = TRUE)))
}
try(ASCIIprofileplot(plotData))

return(list(TotalScore = SCVecs,TotalScoreColor = ColScore,plotData = plotData))
}
#tryError2 <- class(try(TotalScoreRes  <- plot.scores(temp.DataEvidence,qc.prepare.data,i, open.doc = T,pdfOut = T)))

#tryError <- class(try(TotalScoreRes  <- plot.scores(temp.DataEvidence,qc.prepare.data,i, open.doc = F,pdfOut = pdfOut)))

#temp <- start.qc(data)
#try(TotalScoreRes  <- plot.scores(temp.DataEvidence,qc.prepare.data,i, open.doc = T,pdfOut = pdfOut))
#system(paste("open ",list.files(pattern = ".pdf",recursive = T,full.name = T)))